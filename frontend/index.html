<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ABC Analys</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #f7c59f;
            --text-color: #2d3436;
            --background-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: "Arial", sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f6fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
            background: transparent;
            box-shadow: none;
        }
        .preview-section,
        .case-result {
            background: var(--background-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 30px;
            margin-bottom: 20px;
        }
        h1 {
            color: var(--text-color);
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .description {
            color: #636e72;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .difficulty-selector {
            margin: 30px 0;
        }

        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .difficulty-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .difficulty-btn.active {
            border-color: var(--primary-color);
            background-color: var(--secondary-color);
        }

        .difficulty-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .difficulty-name {
            font-weight: bold;
        }

        .generate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .generate-btn:hover {
            background-color: #ff5a1f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .generate-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .case-result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px var(--shadow-color);
        }

        .case-result.hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .difficulty-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .difficulty-btn {
                width: 100%;
            }
        }

        .case-content {
            padding: 30px;
            background: var(--background-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow-color);
        }

        .case-section {
            margin-bottom: 20px;
        }

        .case-section h4 {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }

        .case-section h4::after {
            content: attr(data-subtitle);
            color: #666;
            font-weight: normal;
            margin-left: 5px;
        }

        .case-section p {
            margin: 0;
            line-height: 1.6;
            font-size: 1.1em;
            color: var(--text-color);
        }

        .case-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
        }

        .step-counter {
            color: #666;
            font-size: 0.9em;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            padding: 10px 25px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .next-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .next-btn:hover {
            background-color: #ff5a1f;
        }

        .try-again-btn {
            background-color: #f8f9fa;
            color: #666;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .quiz-section {
            background: var(--background-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 30px;
            margin-top: 20px;
        }

        .quiz-section.hidden {
            display: none;
        }

        .quiz-question {
            font-size: 1.2em;
            color: var(--text-color);
            margin-bottom: 25px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .quiz-option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:hover {
            background: #e9ecef;
        }

        .quiz-option input[type="radio"] {
            margin-right: 15px;
        }

        .option-text {
            font-size: 1.1em;
        }

        .back-btn {
            background-color: #f8f9fa;
            color: #666;
        }

        .case-content.simplified {
            padding: 20px;
            margin-bottom: 20px;
            background: #fff;
            border-radius: 10px;
        }

        .case-content.simplified .case-section {
            margin-bottom: 15px;
        }

        .case-content.simplified .case-section:last-child {
            margin-bottom: 0;
        }

        .case-content.simplified h4 {
            color: #ff6b35;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .case-content.simplified p {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 0;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .case-content.simplified .case-navigation,
        .case-content.simplified .nav-buttons,
        .case-content.simplified .step-counter {
            display: none;
        }

        .case-note-container {
            margin-bottom: 30px;
        }

        .case-note {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
            padding: 20px;
        }

        .case-note-header {
            margin-bottom: 15px;
        }

        .case-note-header h4 {
            color: var(--text-color);
            font-size: 1em;
            margin: 0 0 15px 0;
        }

        .case-note-content .case-item {
            margin-bottom: 12px;
        }

        .case-note-content .case-item:last-child {
            margin-bottom: 0;
        }

        .case-note-content .label {
            color: var(--primary-color);
            font-weight: 500;
            display: block;
            margin-bottom: 4px;
        }

        .case-note-content p {
            margin: 0;
            color: var(--text-color);
            line-height: 1.5;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .quiz-section {
            background: var(--background-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 30px;
            margin-top: 20px;
        }

        .quiz-section.hidden {
            display: none;
        }

        .quiz-question {
            font-size: 1.2em;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .nav-buttons {
            margin-left: auto;
        }

        .case-result.hidden,
        #caseResult.hidden {
            display: none !important;
        }

        .generate-btn-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .regenerate-btn {
            background-color: var(--background-color);
            color: var(--text-color);
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .regenerate-btn:hover {
            background-color: #e9ecef;
            transform: translateY(-1px);
        }

        .case-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .quiz-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:hover {
            background: #e9ecef;
        }

        .quiz-option input[type="radio"] {
            margin: 3px 15px 0 0;
        }

        .option-text {
            font-size: 1.1em;
            line-height: 1.4;
        }

        .quiz-question {
            font-size: 1.2em;
            color: var(--text-color);
            margin: 25px 0;
            line-height: 1.5;
        }

        .quiz-option.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .quiz-option.incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .explanation-box {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .explanation-box.hidden {
            display: none;
        }

        .explanation-box p {
            margin: 0;
            color: var(--text-color);
            line-height: 1.5;
        }

        .next-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }


        .loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader-container {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .loader-animation {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 30px;
        }

        .loader-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-radius: 50%;
            animation: rotate 2s linear infinite;
        }

        .loader-circle:nth-child(1) {
            border-top-color: var(--primary-color);
            animation-delay: 0s;
        }

        .loader-circle:nth-child(2) {
            border-right-color: var(--secondary-color);
            animation-delay: 0.5s;
        }

        .loader-circle:nth-child(3) {
            border-bottom-color: var(--primary-color);
            animation-delay: 1s;
        }

        .loader-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loader-text {
            color: var(--text-color);
            font-size: 1.4em;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .loader-subtext {
            color: #666;
            font-size: 1em;
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.5;
            }

            50% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.5;
            }
        }

        .quiz-result {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .result-header {
            margin-bottom: 30px;
        }

        .result-emoji {
            font-size: 4em;
            display: block;
            margin-bottom: 15px;
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .score-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 8px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: scoreAppear 1s ease-out;
        }

        .score-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .score-label {
            font-size: 1em;
            color: #666;
        }

        .result-message {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 1.1em;
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .result-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .home-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .retry-btn {
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid #ddd;
        }

        .btn-icon {
            font-size: 1.2em;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes scoreAppear {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .reflection-section {
            background: var(--background-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 30px;
            margin-top: 20px;
        }

        .reflection-section.hidden {
            display: none;
        }

        .reflection-question {
            margin-bottom: 30px;
        }

        .reflection-question h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .reflection-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 1em;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .reflection-hint {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
            margin-top: 8px;
        }

        .reflection-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .feedback-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow-color);
        }

        .feedback-form h3 {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .score-slider-container {
            margin: 20px 0;
        }

        .score-slider {
            width: 100%;
            height: 30px;
            margin: 10px 0;
            display: flex;
            gap: 2px;
        }

        .score-block {
            flex: 1;
            height: 100%;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .score-block:hover {
            transform: scaleY(1.1);
        }

        .score-block.active {
            transform: scaleY(1.2);
        }

        .score-value {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
            margin-top: 10px;
        }

        .submit-btn {
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .continue-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .quiz-result .result-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }

        .language-selector.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .lang-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 1em;
            appearance: none;
            -webkit-appearance: none;
            padding-right: 30px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            transition: all 0.3s ease;
        }

        .lang-select:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .final-section {
            background: var(--background-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 30px;
            text-align: center;
            margin: 20px auto;
            max-width: 600px;
        }

        .final-content {
            text-align: center;
        }

        .final-section.hidden {
            display: none;
        }

        .final-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .final-buttons .btn {
            min-width: 150px;
        }

        .cogx-btn {
            background-color: #4a90e2;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .cogx-btn:hover {
            background-color: #357abd;
            transform: translateY(-2px);
        }

        .cogx-btn i {
            font-size: 0.9em;
        }


        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .chat-button:hover {
            transform: scale(1.1);
        }

        .chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        .chat-window.active {
            opacity: 1;
            visibility: visible;
        }

        .chat-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        .chat-message {
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s forwards;
        }

        .chat-message.user {
            display: flex;
            justify-content: flex-end;
        }


        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 15px;
            background: #f0f2f5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
        }

        .chat-message.assistant .message-content {
            background: #fff;
            border: 1px solid #e0e0e0;
        }

        .chat-message.user .message-content {
            background: var(--primary-color);
            color: white;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .chat-input button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .typing-indicator {
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: typing 1s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="language-selector">
            <select class="lang-select" id="langSelect">
                <option value="en">&#127468;&#127463; English</option>
                <option value="ru">&#127479;&#127482; –†—É—Å—Å–∫–∏–π</option>
                <option value="es">&#127466;&#127480; Espa√±ol</option>
            </select>
        </div>
        <div class="preview-section">
            <h1>–ê–Ω–∞–ª–∏–∑ –∫–µ–π—Å–∞ –ø–æ –º–æ–¥–µ–ª–∏ ABC</h1>
            <p class="description">
                –§–æ—Ä–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –∫–≤–∏–∑ –∏ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–µ–π—Å–∞ –ø–æ –º–æ–¥–µ–ª–∏ ABC, –ø–æ–º–æ–≥–∞—è
                –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —É–±–µ–∂–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤–ª–∏—è—é—Ç –Ω–∞ —ç–º–æ—Ü–∏–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ
                –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
            </p>

            <div class="difficulty-selector">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æÔøΩÔøΩ—Ç–∏:</h3>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn" data-difficulty="basic">
                        <span class="difficulty-icon">
                            <i class="fas fa-chess-pawn text-success"></i>
                        </span>
                        <span class="difficulty-name">Basic</span>
                    </button>
                    <button class="difficulty-btn active" data-difficulty="intermediate" onclick="window.location.href='case_generator.html'">
                        <span class="difficulty-icon">
                            <i class="fas fa-chess-knight text-warning"></i>
                        </span>
                        <span class="difficulty-name">Intermediate</span>
                    </button>
                    <button class="difficulty-btn disabled" data-difficulty="advanced" style="opacity: 0.5; cursor: not-allowed;">
                        <span class="difficulty-icon">
                            <i class="fas fa-chess-queen text-secondary"></i>
                        </span>
                        <span class="difficulty-name">Advanced</span>
                        <small class="text-muted d-block">(Coming Soon)</small>
                    </button>
                </div>
            </div>

            <div class="generate-btn-container">
                <button class="generate-btn" id="generateBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–µ–π—Å</button>
            </div>
        </div>

        <div id="loader" class="loader-wrapper" style="display: none;">
            <div class="loader-container">
                <div class="loader-animation">
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <div class="loader-icon"><i class="fas fa-brain"></i></div>
                </div>
                <div class="loader-text">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–µ–π—Å–∞...</div>
                <div class="loader-subtext">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</div>
            </div>
        </div>

        <div class="case-result hidden" id="caseResult">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ–π—Å -->
        </div>

        <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –∫–≤–∏–∑–∞ -->
        <div class="quiz-section hidden" id="quizSection">
            <div class="quiz-content">
                <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–∞–º–µ—Ç–∫–∞ —Å –∫–µ–π—Å–æ–º -->
            </div>
        </div>

        <!-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ quiz-section -->
        <div class="reflection-section hidden" id="reflectionSection">
            <div class="reflection-content">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
            </div>
        </div>
    </div>
    <div id="finalSection" class="final-section hidden">
        <div class="final-content">
            <h2 id="finalTitle"></h2>
            <p id="finalEmailNotice"></p>
            <div class="final-buttons">
                <button class="btn home-btn" onclick="returnToHome()">
                    <i class="fas fa-home"></i>
                    <span class="home-btn-text"></span>
                </button>
                <a href="https://cognitionx.cloud/page58514289.html" target="_blank" class="btn primary-btn cogx-btn">
                    <i class="fas fa-external-link-alt"></i>
                    <span class="cogx-btn-text"></span>
                </a>
            </div>
        </div>
    </div>

    <script>
        const NAV_ICONS = {
            next: `<svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"/>
    </svg>`,
            back: `<svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/>
    </svg>`,
            reload: `<svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
    </svg>`
        };

        const translations = {
            en: {
                title: "ABC Model Case Analysis",
                description:
                    "The form includes a quiz and reflection assignments to analyze the case using the ABC model, helping to understand how client beliefs affect emotions and behavior, and consider alternative interpretations",
                selectDifficulty: "Select difficulty level:",
                difficulties: {
                    basic: "Basic",
                    intermediate: "Intermediate",
                    advanced: "Advanced",
                },
                generateBtn: "Generate Case",
                loading: {
                    case: {
                        text: "Generating case...",
                        subtext: "Creating a unique situation",
                    },
                    quiz: {
                        text: "Preparing questions...",
                        subtext: "Analyzing case and forming tasks",
                    },
                    reflection: {
                        text: "Preparing reflection questions...",
                        subtext: "This may take a few seconds",
                    },
                    saving: {
                        text: "Saving results...",
                        subtext: "Please wait",
                    },
                },
                chat: {
                    welcome: "Hello! I'm your CBT assistant. How can I help you analyze this case?"
                },
                case: {
                    antecedent: "Antecedent (Trigger)",
                    belief: "Belief",
                    consequence: "Consequence",
                    currentCase: "Current Case",
                    regenerate: "Regenerate",
                    simplified: "Simplified Version",
                },
                quiz: {
                    next: "Next",
                    tryAgain: "Try Again",
                    home: "Home",
                    continue: "Continue",
                    step: "Step",
                    of: "of",
                    results: {
                        title: "Test Results",
                        perfect: "Excellent work! You completed the task perfectly!",
                        great: "Very good result! Keep it up!",
                        good: "Good result! Room to grow!",
                        motivate: "Keep practicing! You'll definitely succeed!",
                        points: "points",
                    },
                },
                reflection: {
                    title: "Reflection",
                    back: "Back to Quiz",
                    finish: "Complete",
                    placeholder: "Your answer...",
                    question: "Question",
                    hint: "Hint",
                },
                feedback: {
                    title: "Thank you for completing the assignment!",
                    nameLabel: "Your name *",
                    emailLabel: "Your email *",
                    commentLabel: "Your comments (optional)",
                    emailRequired: "Please enter your email",

                    rateLabel: "Rate the application (1-10)",
                    submit: "Submit",
                    nameRequired: "Please enter your name",
                    saveError: "Error saving results. Please try again.",
                    success: {
                        title: "Thank you for your feedback! ",
                        message: "Your answers have been saved successfully.",
                        home: "Back to Home",
                    },
                    finalMessage: {
                        title: "Thank you for your feedback and participation!",
                        emailNotice: "We will send feedback to your email within 24 hours.",
                        backHome: "Back to Home",
                        visitCogx: "Visit CogX"
                    }
                },
            },
            es: {
                title: "An√°lisis de Casos Modelo ABC",
                description:
                    "El formulario incluye un cuestionario y tareas de reflexi√≥n para analizar el caso utilizando el modelo ABC, ayudando a comprender c√≥mo las creencias del cliente afectan las emociones y el comportamiento, y considerar interpretaciones alternativas",
                selectDifficulty: "Seleccione el nivel de dificultad:",
                difficulties: {
                    basic: "B√°sico",
                    intermediate: "Intermedio",
                    advanced: "Avanzado",
                },
                generateBtn: "Generar Caso",
                loading: {
                    case: {
                        text: "Generando caso...",
                        subtext: "Creando una situaci√≥n √∫nica",
                    },
                    quiz: {
                        text: "Preparando preguntas...",
                        subtext: "Analizando caso y formando tareas",
                    },
                    reflection: {
                        text: "Preparando preguntas de reflexi√≥n...",
                        subtext: "Esto puede tomar unos segundos",
                    },
                    saving: {
                        text: "Guardando resultados...",
                        subtext: "Por favor espere",
                    },
                },
                case: {
                    antecedent: "Antecedente (Disparador)",
                    belief: "Creencia",
                    consequence: "Consecuencia",
                    currentCase: "Caso Actual",
                    regenerate: "Regenerar",
                    simplified: "Versi√≥n Simplificada",
                },
                chat: {
                    welcome: "Hello! I'm your CBT assistant. How can I help you analyze this case?"
                },
                quiz: {
                    next: "Siguiente",
                    tryAgain: "Intentar de nuevo",
                    home: "Inicio",
                    continue: "Continuar",
                    step: "Paso",
                    of: "de",
                    results: {
                        title: "Resultados del Test",
                        perfect: "¬°Excelente trabajo! ¬°Completaste la tarea perfectamente!",
                        great: "¬°Muy buen resultado! ¬°Sigue as√≠!",
                        good: "¬°Buen resultado! ¬°Hay espacio para crecer!",
                        motivate: "¬°Sigue practicando! ¬°Lo lograr√°s definitivamente!",
                        points: "puntos",
                    },
                },
                reflection: {
                    title: "Reflexi√≥n",
                    back: "Volver al Quiz",
                    finish: "Completar",
                    placeholder: "Tu respuesta...",
                    question: "Pregunta",
                    hint: "Sugerencia",
                },
                feedback: {
                    title: "¬°Gracias por completar la tarea!",
                    nameLabel: "Tu nombre *",
                    emailLabel: "Tu email *",
                    rateLabel: "Califica la aplicaci√≥n (1-10)",
                    submit: "Enviar",
                    commentLabel: 'Enter Comment',
                    nameRequired: "Por favor, ingrese su nombre",
                    saveError:
                        "Error al guardar los resultados. Por favor, int√©ntelo de nuevo.",
                    success: {
                        title: "¬°Gracias por tu feedback! ",
                        message: "Tus respuestas se han guardado exitosamente.",
                        home: "Volver al Inicio",
                    },
                    finalMessage: {
                        title: "¬°Gracias por sus comentarios y participaci√≥n!",
                        emailNotice: "Enviaremos comentarios a su correo electr√≥nico dentro de las 24 horas.",
                        backHome: "Volver al inicio",
                        visitCogx: "Visitar CogX"
                    }
                },
            },
            ru: {
                title: "–ê–Ω–∞–ª–∏–∑ –∫–µ–π—Å–∞ –ø–æ –º–æ–¥–µ–ª–∏ ABC",
                description:
                    "–§–æ—Ä–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –∫–≤–∏–∑ –∏ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–µ–π—Å–∞ –ø–æ –º–æ–¥–µ–ª–∏ ABC, –ø–æ–º–æ–≥–∞—è –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —É–±–µ–∂–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤–ª–∏—è—é—Ç –Ω–∞ —ç–º–æ—Ü–∏–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏",
                selectDifficulty: "–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:",
                difficulties: {
                    basic: "–ë–∞–∑–æ–≤—ã–π",
                    intermediate: "–°—Ä–µ–¥–Ω–∏–π",
                    advanced: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π",
                },
                generateBtn: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–µ–π—Å",
                chat: {
                    welcome: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à –ö–ü–¢-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–ª—É—á–∞–π?"
                },
                loading: {
                    case: {
                        text: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–µ–π—Å–∞...",
                        subtext: "–°–æ–∑–¥–∞—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é",
                    },
                    quiz: {
                        text: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...",
                        subtext: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–µ–π—Å –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è",
                    },
                    reflection: {
                        text: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏...",
                        subtext: "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥",
                    },
                    saving: {
                        text: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...",
                        subtext: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ",
                    },
                },
                case: {
                    antecedent: "–ê–Ω—Ç–µ—Ü–µ–¥–µ–Ω—Ç (–¢—Ä–∏–≥–≥–µ—Ä)",
                    belief: "–£–±–µ–∂–¥–µ–Ω–∏–µ",
                    consequence: "–°–ª–µ–¥—Å—Ç–≤–∏–µ",
                    currentCase: "–¢–µ–∫—É—â–∏–π –∫–µ–π—Å",
                    regenerate: "–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å",
                    simplified: "–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è",
                },
                quiz: {
                    next: "–î–∞–ª–µ–µ",
                    tryAgain: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",
                    home: "–ù–∞ –≥–ª–∞–≤–Ω—É—é",
                    continue: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                    step: "–®–∞–≥",
                    of: "–∏–∑",
                    results: {
                        title: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞",
                        perfect: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã –±–µ–∑—É–ø—Ä–µ—á–Ω–æ —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å —Å –∑–∞–¥–∞–Ω–∏–µ–º!",
                        great: "–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
                        good: "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ï—Å—Ç—å –∫—É–¥–∞ —Ä–∞—Å—Ç–∏!",
                        motivate: "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è! –£ –≤–∞—Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—Å—è!",
                        points: "–±–∞–ª–ª–æ–≤",
                    },
                },
                reflection: {
                    title: "–†–µ—Ñ–ª–µ–∫—Å–∏—è",
                    back: "–ù–∞–∑–∞–¥ –∫ –∫–≤–∏–∑—É",
                    finish: "–ó–∞–≤–µ—Ä—à–∏—Ç—å",
                    placeholder: "–í–∞—à –æ—Ç–≤–µ—Ç...",
                    question: "–í–æ–ø—Ä–æ—Å",
                    hint: "–ü–æ–¥—Å–∫–∞–∑–∫–∞",
                },
                feedback: {
                    title: "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è!",
                    nameLabel: "–í–∞—à–µ –∏–º—è *",
                    emailLabel: "–í–∞—à email *",
                    emailRequired: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email",
                    rateLabel: "–û—Ü–µ–Ω–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–æ—Ç 1 –¥–æ 10)",
                    commentLabel: "–í–∞—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)",
                    submit: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                    nameRequired: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è",
                    saveError:
                        "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                    success: {
                        title: "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! ",
                        message: "–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.",
                        home: "–ù–∞ –≥–ª–∞–≤–Ω—É—é",
                    },
                    finalMessage: {
                        title: "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤ –∏ —É—á–∞—Å—Ç–∏–µ!",
                        emailNotice: "–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º —Ñ–∏–¥–±–µ–∫ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.",
                        backHome: "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é",
                        visitCogx: "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ CogX"
                    }
                },
            },
        };


                let currentCaseData = null;
        let currentQuizData = null;
        let currentQuizStep = 1;
        let userAnswers = [];
        let currentReflectionData = null;
        let selectedDifficulty = 'medium';
        let currentLanguage = 'en';
        let isChatOpen = false;
        let isAssistantTyping = false;

                const QUIZ_STATES = {
            INITIAL: "initial",
            IN_PROGRESS: "in_progress",
            COMPLETED: "completed",
        };
        const LOADER_STATES = {
            CASE: {
                icon: '<i class="fas fa-file-alt"></i>',
                text: {
                    ru: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–µ–π—Å–∞...",
                    en: "Generating case...",
                    es: "Generando caso...",
                },
                subtext: {
                    ru: "–°–æ–∑–¥–∞—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é",
                    en: "Creating a unique situation",
                    es: "Creando una situaci√≥n √∫nica",
                },
            },
            QUIZ: {
                icon: '<i class="fas fa-brain"></i>',
                text: {
                    ru: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...",
                    en: "Preparing questions...",
                    es: "Preparando preguntas...",
                },
                subtext: {
                    ru: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–µ–π—Å –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è",
                    en: "Analyzing case and forming tasks",
                    es: "Analizando caso y formando tareas",
                },
            },
            REFLECTION: {
                icon: '<i class="fas fa-lightbulb"></i>',
                text: {
                    ru: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏...",
                    en: "Preparing reflection questions...",
                    es: "Preparando preguntas de reflexi√≥n...",
                },
                subtext: {
                    ru: "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥",
                    en: "This may take a few seconds",
                    es: "Esto puede tomar unos segundos",
                },
            },
            SAVING: {
                icon: '<i class="fas fa-save"></i>',
                text: {
                    ru: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...",
                    en: "Saving results...",
                    es: "Guardando resultados...",
                },
                subtext: {
                    ru: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ",
                    en: "Please wait",
                    es: "Por favor espere",
                },
            },
        };

        function updateFinalSection() {
            const finalSection = document.getElementById('finalSection');
            if (!finalSection) {
                console.error('Final section not found');
                return;
            }

            const t = translations[currentLanguage].feedback.finalMessage;

                        const elements = {
                'finalTitle': document.getElementById('finalTitle'),
                'finalEmailNotice': document.getElementById('finalEmailNotice'),
                'home-btn-text': finalSection.querySelector('.home-btn-text'),
                'cogx-btn-text': finalSection.querySelector('.cogx-btn-text')
            };

                        for (const [key, element] of Object.entries(elements)) {
                if (!element) {
                    console.error(`Element ${key} not found`);
                    continue;
                }

                switch (key) {
                    case 'finalTitle':
                        element.textContent = t.title;
                        break;
                    case 'finalEmailNotice':
                        element.textContent = t.emailNotice;
                        break;
                    case 'home-btn-text':
                        element.textContent = t.backHome;
                        break;
                    case 'cogx-btn-text':
                        element.textContent = t.visitCogx;
                        break;
                }
            }
        }
                document.getElementById('langSelect').addEventListener('change', (e) => {
            changeLanguage(e.target.value);
        });

        function showFinalSection() {
                        const sectionsToHide = [
                '.preview-section',
                '.case-result',
                '#quizSection',
                '#reflectionSection',
                '#feedbackSection'
            ];

            sectionsToHide.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    element.style.display = 'none';
                }
            });

                        const finalSection = document.getElementById('finalSection');
            if (finalSection) {
                updateFinalSection();                 finalSection.classList.remove('hidden');
                finalSection.style.display = 'block';
            } else {
                console.error('Final section element not found');
            }
        }

        let chatHistory = [];
        function initChat() {
            const chatButton = document.querySelector('.chat-button');
            const chatWindow = document.querySelector('.chat-window');
            const chatInput = chatWindow.querySelector('input');
            const sendButton = chatWindow.querySelector('button');
            const messagesContainer = chatWindow.querySelector('.chat-messages');

                        messagesContainer.innerHTML = '';
            chatHistory = [];

                        chatButton.classList.remove('hidden');

                        chatButton.addEventListener('click', () => {
                isChatOpen = !isChatOpen;
                chatWindow.classList.toggle('active', isChatOpen);
            });

                        const welcomeMessage = translations[currentLanguage].chat.welcome;
            appendMessage(welcomeMessage, 'assistant');
            chatHistory.push({ role: 'assistant', content: welcomeMessage });

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message || isAssistantTyping) return;

                                appendMessage(message, 'user');
                chatInput.value = '';

                                chatHistory.push({ role: 'user', content: message });

                isAssistantTyping = true;
                sendButton.disabled = true;

                const typingIndicator = appendMessage('', 'assistant', true);

                try {
                    const response = await fetch('https://cbtlab.tech/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message,
                            caseData: currentCaseData,
                            language: currentLanguage,
                            messageHistory: chatHistory
                        })
                    });

                    const data = await response.json();

                    typingIndicator.remove();

                    if (data.reply) {
                        appendMessage(data.reply, 'assistant');
                                                chatHistory.push({ role: 'assistant', content: data.reply });

                                                if (chatHistory.length > 20) {
                            chatHistory = chatHistory.slice(-20);
                        }
                    } else {
                        throw new Error('No reply received');
                    }

                } catch (error) {
                    console.error('Chat error:', error);
                    typingIndicator.remove();
                    appendMessage(translations[currentLanguage].errors?.chatError || 'Sorry, I encountered an error. Please try again.', 'assistant');
                } finally {
                    isAssistantTyping = false;
                    sendButton.disabled = false;
                }
            }

                        sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });


            function appendMessage(text, sender, isTyping = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;

                if (isTyping) {
                    messageDiv.innerHTML = `
      <div class="message-content typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
                } else {
                    messageDiv.innerHTML = `
      <div class="message-content">${text}</div>
    `;
                }

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return messageDiv;
            }
        }

        function parseCase(caseText) {
            try {
                const caseData = {
                    antecedent: "",
                    belief: "",
                    consequence: "",
                };

                                const patterns = {
                    antecedent: {
                        ru: /(?:–ê–Ω—Ç–µ—Ü–µ–¥–µ–Ω—Ç|Antecedent):\s*"([^"]+)"/,
                        en: /(?:Antecedent):\s*"([^"]+)"/,
                        es: /(?:Antecedente):\s*"([^"]+)"/,
                    },
                    belief: {
                        ru: /(?:–£–±–µ–∂–¥–µ–Ω–∏–µ|Belief):\s*"([^"]+)"/,
                        en: /(?:Belief):\s*"([^"]+)"/,
                        es: /(?:Creencia):\s*"([^"]+)"/,
                    },
                    consequence: {
                        ru: /(?:–°–ª–µ–¥—Å—Ç–≤–∏–µ|Consequence).*?:\s*"([^"]+)"/,
                        en: /(?:Consequence).*?:\s*"([^"]+)"/,
                        es: /(?:Consecuencia).*?:\s*"([^"]+)"/,
                    },
                };

                const antecedentMatch = caseText.match(
                    patterns.antecedent[currentLanguage]
                );
                const beliefMatch = caseText.match(patterns.belief[currentLanguage]);
                const consequenceMatch = caseText.match(
                    patterns.consequence[currentLanguage]
                );

                if (!antecedentMatch || !beliefMatch || !consequenceMatch) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–µ–π—Å–∞");
                }

                caseData.antecedent = antecedentMatch[1].trim();
                caseData.belief = beliefMatch[1].trim();
                caseData.consequence = consequenceMatch[1].trim();

                                for (const [key, value] of Object.entries(caseData)) {
                    if (!value || value.length < 10) {
                        throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ${key}`);
                    }
                }

                return caseData;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∫–µ–π—Å–∞:", error);
                throw new Error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–µ–π—Å–∞: ${error.message}`);
            }
        }

        function createCaseElement(caseData) {
            const t = translations[currentLanguage];
            return `
    <div class="case-content">
        <div class="case-section">
            <h4>${t.case?.antecedent || "Antecedent"}:</h4>
            <p>"${caseData.antecedent}"</p>
        </div>
        <div class="case-section">
            <h4>${t.case?.belief || "Belief"}:</h4>
            <p>"${caseData.belief}"</p>
        </div>
        <div class="case-section">
            <h4>${t.case?.consequence || "Consequence"}:</h4>
            <p>"${caseData.consequence}"</p>
        </div>
        <div class="case-navigation">
            <button class="regenerate-btn">‚Üª ${t.case?.regenerate ||
                "Regenerate"}</button>
            <div class="nav-buttons">
                <button class="nav-btn next-btn">${NAV_ICONS.next} ${t.quiz?.next ||
                "Next"}</button>
            </div>
        </div>
    </div>
  `;
        }
        async function generateCase(difficulty, maxAttempts = 3) {
            let attempts = 0;

            while (attempts < maxAttempts) {
                try {
                    showLoader(LOADER_STATES.CASE);
                    const response = await fetch("https://cbtlab.tech/api/generate-case", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            difficulty,
                            language: currentLanguage,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.case || typeof data.case !== "string") {
                        throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                    }

                                        const parsedCase = parseCase(data.case);
                    return parsedCase; 

                } catch (error) {
                    attempts++;
                    console.error(`–ü–æ–ø—ã—Ç–∫–∞ ${attempts} –Ω–µ —É–¥–∞–ª–∞—Å—å:`, error);

                                        if (attempts === maxAttempts) {
                        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–µ–π—Å –ø–æ—Å–ª–µ ${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
                    }

                                        await new Promise(resolve => setTimeout(resolve, 1000));

                                    } finally {
                    if (attempts === maxAttempts) {
                        hideLoader();
                    }
                }
            }
        }
                function createSimplifiedCaseElement(caseData) {
            return `
    <div class="case-content simplified">
        <div class="case-section">
            <h4>Antecedent (–¢—Ä–∏–≥–≥–µ—Ä):</h4>
            <p>${caseData.antecedent}</p>
        </div>
        <div class="case-section">
            <h4>Belief (–£–±–µ–¥–µ–Ω–∏–µ):</h4>
            <p>${caseData.belief}</p>
        </div>
        <div class="case-section">
            <h4>Consequence (–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è):</h4>
            <p>${caseData.consequence}</p>
        </div>
    </div>
  `;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const previewSection = document.querySelector(".preview-section");
            const generateBtn = document.getElementById("generateBtn");
            const loader = document.getElementById("loader");

                        const difficultyBtns = document.querySelectorAll(".difficulty-btn");
            difficultyBtns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    difficultyBtns.forEach((b) => b.classList.remove("active"));
                    btn.classList.add("active");
                    selectedDifficulty = btn.dataset.difficulty;
                });
            });

            generateBtn.addEventListener("click", async () => {
                previewSection.style.display = "none";
                loader.style.display = "flex";
                hideLanguageSelector();

                try {
                    const result = await generateCase(selectedDifficulty);
                    currentCaseData = result;
                    const caseHtml = createCaseElement(currentCaseData);

                    const container = document.querySelector(".container");
                    const caseElement = document.createElement("div");
                    caseElement.className = "case-result";
                    caseElement.innerHTML = caseHtml;

                                        const oldCaseResult = document.querySelector(".case-result");
                    if (oldCaseResult) {
                        oldCaseResult.remove();
                    }

                    loader.style.display = "none";
                    container.appendChild(caseElement);

                                        setupButtonHandlers(currentCaseData);



                } catch (error) {
                    console.error("Generation error:", error);
                    loader.style.display = "none";
                    alert(error.message);
                    previewSection.style.display = "block";
                    showLanguageSelector();
                }
            });
                        updateHomeButtons();
        });
        function createCaseNote(caseData) {
            const t = translations[currentLanguage];
            return `
    <div class="case-note">
        <div class="case-note-header">
            <h4>${t.case?.currentCase || "Current Case"}:</h4>
        </div>
        <div class="case-note-content">
            <div class="case-item">
                <span class="label">${t.case?.antecedent ||
                "Antecedent"}:</span>
                <p>${caseData.antecedent}</p>
            </div>
            <div class="case-item">
                <span class="label">${t.case?.belief || "Belief"}:</span>
                <p>${caseData.belief}</p>
            </div>
            <div class="case-item">
                <span class="label">${t.case?.consequence ||
                "Consequence"}:</span>
                <p>${caseData.consequence}</p>
            </div>
        </div>
    </div>
  `;
        }
        async function generateQuiz(caseData) {
            try {
                const response = await fetch("https://cbtlab.tech/api/generate-quiz", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        case: caseData,
                        language: currentLanguage,                     }),
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–≤–∏–∑–∞:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–≤–∏–∑: ${error.message}`);
            }
        }

        function parseQuizOption(optionText) {
                        const cleanText = optionText.split("\n")[0].trim();
                        return cleanText.replace(/\*\*/g, "");
        }

        function displayQuiz(quizData) {
            const t = translations[currentLanguage];
            const quizSection = document.getElementById("quizSection");
            const quizContent = quizSection.querySelector(".quiz-content");
            const loader = document.getElementById("loader");

            try {
                                if (
                    !quizData ||
                    !quizData.questions ||
                    !Array.isArray(quizData.questions)
                ) {
                    throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–≤–∏–∑–∞");
                }

                const currentQuestion = quizData.questions[currentQuizStep - 1];
                if (!currentQuestion) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å");
                }

                loader.style.display = "none";
                quizContent.innerHTML = `
      <div class="case-note-container">
        ${createCaseNote(currentCaseData)}
      </div>
      <h3 class="quiz-question">${currentQuestion.question}</h3>
      <div class="quiz-options">
        ${currentQuestion.options
                        .map(
                            (option) => `
          <label class="quiz-option">
            <input type="radio" name="quiz-answer" value="${option.value}">
            <span class="option-text">${parseQuizOption(option.text)}</span>
          </label>
        `
                        )
                        .join("")}
      </div>
      <div class="explanation-box hidden"></div>
      <div class="quiz-navigation">
        <span class="step-counter">${t.quiz.step}: ${currentQuizStep}/${quizData.totalQuestions
                    }</span>
        <div class="nav-buttons">
          <button class="nav-btn next-btn" disabled>${t.quiz.next} ‚Üí</button>
        </div>
      </div>
    `;

                                setupQuizHandlers(currentQuestion);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫–≤–∏–∑–∞:", error);
                loader.style.display = "none";
                alert(error.message);
            }
        }

        function setupQuizHandlers(currentQuestion) {
            const quizContent = document.querySelector(".quiz-content");
            const radioButtons = quizContent.querySelectorAll('input[type="radio"]');
            const nextBtn = quizContent.querySelector(".next-btn");
            const explanationBox = quizContent.querySelector(".explanation-box");

            radioButtons.forEach((radio) => {
                radio.addEventListener("change", () => {
                    nextBtn.disabled = false;

                                        userAnswers[currentQuizStep - 1] = radio.value;

                                        const selectedOption = radio.value;
                    const correctAnswer = currentQuestion.correctAnswer;

                                        radioButtons.forEach((rb) => {
                        const optionLabel = rb.closest(".quiz-option");
                        if (rb.value === correctAnswer) {
                            optionLabel.classList.add("correct");
                        } else if (rb.value === selectedOption) {
                            optionLabel.classList.add("incorrect");
                        }
                        rb.disabled = true;
                    });

                                        explanationBox.innerHTML = `<p>${currentQuestion.explanation}</p>`;
                    explanationBox.classList.remove("hidden");
                });
            });

                        nextBtn.addEventListener("click", () => {
                if (currentQuizStep < currentQuizData.totalQuestions) {
                    currentQuizStep++;
                    displayQuiz(currentQuizData);
                } else {
                    handleQuizCompletion();
                }
            });
        }

                async function initQuiz(caseData) {
            const quizSection = document.getElementById("quizSection");
            const caseResult = document.querySelector(".case-result");

            try {
                showLoader({
                    icon: "",
                    text: {
                        ru: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...",
                        en: "Preparing questions...",
                        es: "Preparando preguntas...",
                    },
                    subtext: {
                        ru: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–µ–π—Å –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è",
                        en: "Analyzing case and forming tasks",
                        es: "Analizando caso y formando tareas",
                    },
                });

                currentQuizData = await generateQuiz(caseData);
                currentQuizStep = 1;
                userAnswers = [];

                caseResult.classList.add("hidden");
                quizSection.classList.remove("hidden");
                displayQuiz(currentQuizData);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–≤–∏–∑–∞:", error);
                throw error;
            } finally {
                hideLoader();
            }
        }
        function handleNextQuestion() {
            if (currentQuizStep < currentQuizData.totalQuestions) {
                currentQuizStep++;
                const currentQuestion = currentQuizData.questions[currentQuizStep - 1];
                displayQuiz({
                    question: currentQuestion.question,
                    options: currentQuestion.options,
                    currentStep: currentQuizStep,
                    totalSteps: currentQuizData.totalQuestions,
                });
            } else {
                handleQuizCompletion();
            }
        }

        function setupButtonHandlers(caseData) {
            const nextBtn = document.querySelector(".next-btn");
            if (nextBtn) {
                nextBtn.addEventListener("click", () => {
                    handleNextStep();
                });
            }

                        const regenerateBtn = document.querySelector(".regenerate-btn");
            if (regenerateBtn) {
                regenerateBtn.addEventListener("click", async () => {
                    const caseResult = document.querySelector(".case-result");
                    const quizSection = document.getElementById("quizSection");
                    const loader = document.getElementById("loader");

                                        const oldNoteContainer = quizSection.querySelector(
                        ".case-note-container"
                    );
                    if (oldNoteContainer) {
                        oldNoteContainer.remove();
                    }

                    caseResult.classList.add("hidden");
                    quizSection.classList.add("hidden");
                    loader.style.display = "flex";

                    try {
                        const newResult = await generateCase(selectedDifficulty);
                        currentCaseData = newResult;
                        caseResult.innerHTML = createCaseElement(currentCaseData);
                        caseResult.classList.remove("hidden");

                                                setupButtonHandlers(currentCaseData);
                    } catch (error) {
                        alert(error.message);
                    }
                    loader.style.display = "none";
                });
            }
        }
        function createQuizResultWindow(score, total) {
            const t = translations[currentLanguage];
            const percentage = (score / total) * 100;
            let emoji, message;
            const RESULT_ICONS = {
                perfect: `<svg viewBox="0 0 24 24" width="48" height="48">
        <path fill="currentColor" d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
    </svg>`,
                great: `<svg viewBox="0 0 24 24" width="48" height="48">
        <path fill="currentColor" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/>
    </svg>`,
                good: `<svg viewBox="0 0 24 24" width="48" height="48">
        <path fill="currentColor" d="M5,9V21H1V9H5M9,21A2,2 0 0,1 7,19V9C7,8.45 7.22,7.95 7.59,7.59L14.17,1L15.23,2.06C15.5,2.33 15.67,2.7 15.67,3.11L15.64,3.43L14.69,8H21C22.11,8 23,8.9 23,10V12C23,12.26 22.95,12.5 22.86,12.73L19.84,19.78C19.54,20.5 18.83,21 18,21H9M9,19H18.03L21,12V10H12.21L13.34,4.68L9,9.03V19Z"/>
    </svg>`,
                motivate: `<svg viewBox="0 0 24 24" width="48" height="48">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/>
    </svg>`
            };
            if (percentage === 100) {
                emoji = RESULT_ICONS.perfect;
                message = t.quiz.results.perfect;
            } else if (percentage >= 80) {
                emoji = RESULT_ICONS.great;
                message = t.quiz.results.great;
            } else if (percentage >= 60) {
                emoji = RESULT_ICONS.good;
                message = t.quiz.results.good;
            } else {
                emoji = RESULT_ICONS.motivate;
                message = t.quiz.results.motivate;
            }

            return `
    <div class="quiz-result">
      <div class="result-header">
        <span class="result-emoji">${emoji}</span>
        <h3>${t.quiz.results.title}</h3>
      </div>
      <div class="score-container">
        <div class="score-circle">
          <span class="score-number">${score}/${total}</span>
          <span class="score-label">${t.quiz.results.points}</span>
        </div>
      </div>
      <div class="result-message">
        ${message}
      </div>
      <div class="result-actions">
        <button class="result-btn retry-btn">
          <span class="btn-icon"><i class="ph ph-arrows-clockwise"></i></span>
          ${t.quiz.tryAgain}
        </button>
      </div>
    </div>
  `;


        }
        function handleQuizCompletion() {
            const quizSection = document.getElementById("quizSection");
            const score = calculateScore();

                        quizSection.innerHTML = createQuizResultWindow(
                score,
                currentQuizData.totalQuestions
            );

                        const resultActions = quizSection.querySelector(".result-actions");
            const continueBtn = document.createElement("button");
            continueBtn.className = "result-btn continue-btn";
            continueBtn.innerHTML = `
        <span class="btn-icon"><i class="ph ph-arrow-right"></i></span>
        ${translations[currentLanguage].quiz.continue}
    `;
            resultActions.appendChild(continueBtn);

                        const retryBtn = quizSection.querySelector(".retry-btn");
            const continueBtnElement = quizSection.querySelector(".continue-btn");

            if (retryBtn) {
                retryBtn.addEventListener("click", () => {
                    quizSection.innerHTML = '<div class="quiz-content"></div>';
                    currentQuizStep = 1;
                    userAnswers = [];
                    displayQuiz(currentQuizData);
                });
            }

            if (continueBtnElement) {
                continueBtnElement.addEventListener("click", async () => {
                    try {
                        showLoader(LOADER_STATES.REFLECTION);
                        currentReflectionData = await generateReflection(currentCaseData);
                        quizSection.classList.add("hidden");
                        const reflectionSection = document.getElementById("reflectionSection");
                        reflectionSection.classList.remove("hidden");
                        displayReflection(currentReflectionData);
                    } catch (error) {
                        console.error("Error generating reflection:", error);
                        alert(translations[currentLanguage].errors?.reflectionGeneration || "Error generating reflection questions");
                    } finally {
                        hideLoader();
                        initChat();
                    }
                });
            }
        }

        function calculateScore() {
            return userAnswers.filter(
                (answer, index) => answer === currentQuizData.questions[index].correctAnswer
            ).length;
        }
        function showLoader(state = LOADER_STATES.CASE) {
            const loader = document.getElementById("loader");
            const icon = loader.querySelector(".loader-icon");
            const text = loader.querySelector(".loader-text");
            const subtext = loader.querySelector(".loader-subtext");

            icon.innerHTML = state.icon;             text.textContent = state.text[currentLanguage];
            subtext.textContent = state.subtext[currentLanguage];

            loader.style.display = "flex";
        }

        function hideLoader() {
            const loader = document.getElementById("loader");
            loader.style.display = "none";
        }


                async function handleNextStep() {
            const caseResult = document.querySelector('.case-result');
            const quizSection = document.getElementById('quizSection');

            showLoader({
                icon: "",
                text: {
                    ru: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...",
                    en: "Preparing questions...",
                    es: "Preparando preguntas...",
                },
                subtext: {
                    ru: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–µ–π—Å –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è",
                    en: "Analyzing case and forming tasks",
                    es: "Analizando caso y formando tareas",
                },
            });
            try {
                await initQuiz(currentCaseData);
                caseResult.classList.add('hidden');
                quizSection.classList.remove('hidden');

            } catch (error) {
                console.error('Quiz initialization error:', error);
                alert(error.message);
            } finally {
                hideLoader();
            }
        }

        async function generateReflection(caseData) {
            try {
                const response = await fetch(
                    "https://cbtlab.tech/api/generate-reflection",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            case: caseData,
                            language: currentLanguage,                         }),
                    }
                );

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:", error);
                throw error;
            }
        }
                function displayReflection(reflectionData) {
            const t = translations[currentLanguage];
            const reflectionSection = document.getElementById("reflectionSection");
            const reflectionContent = reflectionSection.querySelector(
                ".reflection-content"
            );

            reflectionContent.innerHTML = `
    <div class="case-note-container">
      ${createCaseNote(currentCaseData)}
    </div>
    ${reflectionData.questions
                    .map(
                        (q, index) => `
      <div class="reflection-question">
        <h4>${t.reflection.question} ${index + 1}</h4>
        <p>${q.question}</p>
        <textarea class="reflection-textarea" placeholder="${t.reflection.placeholder
                            }"></textarea>
        ${q.hint
                                ? `<div class="reflection-hint"><i class="ph ph-lightbulb"></i> ${t.reflection.hint}: ${q.hint}</div>`
                                : ""
                            }
      </div>
    `
                    )
                    .join("")}
    <div class="reflection-navigation">
      <button class="nav-btn back-btn">‚Üê ${t.reflection.back}</button>
      <button class="nav-btn next-btn">${t.reflection.finish}</button>
    </div>
  `;

                        setupReflectionHandlers();
        }

                function setupReflectionHandlers() {
            const reflectionSection = document.getElementById("reflectionSection");
            const backBtn = reflectionSection.querySelector(".back-btn");
            const nextBtn = reflectionSection.querySelector(".next-btn");

            backBtn.addEventListener("click", () => {
                reflectionSection.classList.add("hidden");
                document.getElementById("quizSection").classList.remove("hidden");
            });

            nextBtn.addEventListener("click", async () => {
                                const reflectionAnswers = Array.from(
                    reflectionSection.querySelectorAll(".reflection-textarea")
                ).map((textarea, index) => ({
                    questionId: index + 1,
                    answer: textarea.value.trim(),
                }));

                                reflectionSection.innerHTML = createFeedbackForm();
                setupFeedbackHandlers(reflectionAnswers);
            });
        }
        function setupFeedbackHandlers(reflectionAnswers) {
            const form = document.getElementById("feedbackForm");
                        window.selectedScore = 5; 
                        const scoreSlider = form.querySelector(".score-slider");
            const scoreValue = form.querySelector(".score-value");

            if (scoreSlider) {
                scoreSlider.addEventListener("click", (e) => {
                    const block = e.target.closest(".score-block");
                    if (block) {
                        window.selectedScore = parseInt(block.dataset.value);
                        scoreValue.textContent = window.selectedScore;

                                                scoreSlider.querySelectorAll(".score-block").forEach((block, i) => {
                            block.classList.toggle("active", i < window.selectedScore);
                        });
                    }
                });
            }

                        const submitBtn = form.querySelector(".submit-btn");
            if (submitBtn) {
                submitBtn.addEventListener("click", async () => {
                    const name = form.querySelector("#name")?.value.trim();
                    const email = form.querySelector("#email")?.value.trim();
                    const comment = form.querySelector("#comment")?.value.trim();

                    if (!name || !email) {
                        alert(
                            !name
                                ? translations[currentLanguage].feedback.nameRequired
                                : translations[currentLanguage].feedback.emailRequired
                        );
                        return;
                    }

                    try {
                        showLoader(LOADER_STATES.SAVING);

                                                if (!currentQuizData || !currentQuizData.questions) {
                            throw new Error('Quiz data is missing');
                        }

                                                const quizScore = userAnswers.filter(
                            (answer, index) => answer === currentQuizData.questions[index].correctAnswer
                        ).length;

                                                const formattedReflectionAnswers = reflectionAnswers.map((answer, index) => ({
                            questionId: index + 1,
                            question: currentReflectionData?.questions[index]?.question || '',
                            answer: answer.answer
                        }));

                        const formData = {
                            name,
                            email,
                            score: window.selectedScore || 0,                             comment,
                            reflectionAnswers: formattedReflectionAnswers,
                            caseData: currentCaseData || {},
                            quizAnswers: userAnswers || [],
                            language: currentLanguage || 'en',
                            quizScore,
                            totalQuestions: currentQuizData.questions.length,
                            difficulty: selectedDifficulty || 'medium',
                            currentQuizData
                        };

                        console.log('Sending data:', formData); 
                        const response = await fetch("https://cbtlab.tech/api/save-results", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(formData)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || translations[currentLanguage].feedback.saveError);
                        }

                        const sections = [
                            document.querySelector(".case-result"),
                            document.getElementById("quizSection"),
                            document.getElementById("reflectionSection"),
                            document.getElementById("feedbackSection")

                        ];

                        sections.forEach(section => {
                            if (section) section.classList.add('hidden');
                        });

                                                showFinalSection();


                                                currentCaseData = null;
                        currentQuizData = null;
                        currentQuizStep = 1;
                        userAnswers = [];
                        currentReflectionData = null;
                        window.selectedScore = 5;
                        reflectionAnswers = [];

                                                document.querySelectorAll(".final-section .home-btn").forEach(btn => {
                            btn.addEventListener("click", () => {
                                finalSection.classList.add("hidden");
                                document.querySelector(".preview-section").style.display = "block";
                                showLanguageSelector();
                            });
                        });

                    } catch (error) {
                        console.error("Error saving results:", error);
                        alert(`${translations[currentLanguage].feedback.saveError}: ${error.message}`);
                    } finally {
                        hideLoader();
                    }
                });
            }
        }

        function createFeedbackForm() {
            const t = translations[currentLanguage];
            return `
<div class="feedback-form" id="feedbackForm">
        <h3>${t.feedback.title}</h3>
        <div class="form-group">
            <label for="name">${t.feedback.nameLabel}</label>
            <input type="text" id="name" class="form-input" required>
        </div>
        <div class="form-group">
            <label for="email">${t.feedback.emailLabel}</label>
            <input type="email" id="email" class="form-input" required>
        </div>
        <div class="form-group">
            <label>${t.feedback.rateLabel}</label>
            <div class="score-slider-container">
                <div class="score-slider">
                    ${Array.from({ length: 10 }, (_, i) => i + 1)
                    .map(num => `
                            <div class="score-block${num <= 5 ? ' active' : ''}" 
                                data-value="${num}" 
                                style="background: ${getScoreGradient(num)}">
                            </div>
                        `).join('')}
                </div>
                <div class="score-value">5</div>
            </div>
        </div>
        <div class="form-group">
            <label for="comment">${t.feedback.commentLabel}</label>
            <textarea id="comment" class="form-input" rows="3"></textarea>
        </div>
        <button type="button" class="submit-btn primary-btn">${t.feedback.submit}</button>
    </div>
    `;
        }
                function getScoreGradient(score) {
            const red = Math.max(0, (255 * (10 - score)) / 5);
            const green = Math.max(0, (255 * score) / 5);
            return `rgb(${red}, ${green}, 0)`;
        }

                function changeLanguage(lang) {
            currentLanguage = lang;
            updateInterface();
            updateFinalSection();
        }

                function updateInterface() {
            const t = translations[currentLanguage];

                        document.querySelector("h1").textContent = t.title;
            document.querySelector(".description").textContent = t.description;
            document.querySelector(".difficulty-selector h3").textContent =
                t.selectDifficulty;

                        document
                .querySelectorAll(".difficulty-btn .difficulty-name")
                .forEach((btn) => {
                    const difficulty = btn.closest(".difficulty-btn").dataset.difficulty;
                    btn.textContent = t.difficulties[difficulty];
                });

                        document.querySelector("#generateBtn").textContent = t.generateBtn;

                        const elements = {
                ".loader-text": t.loading?.case?.text,
                ".loader-subtext": t.loading?.case?.subtext,
                ".next-btn": t.quiz?.next,
                ".back-btn": t.reflection?.back,
                ".try-again-btn": t.quiz?.tryAgain,
                ".home-btn": t.quiz?.home,
                ".continue-btn": t.quiz?.continue,
            };

            for (const [selector, text] of Object.entries(elements)) {
                const element = document.querySelector(selector);
                if (element && text) {
                    element.textContent = text;
                }
            }
        }
                document.addEventListener("DOMContentLoaded", () => {
            const langSelect = document.getElementById("langSelect");

                        currentLanguage = "en";
            langSelect.value = currentLanguage;

            langSelect.addEventListener("change", (e) => {
                changeLanguage(e.target.value);
            });

                        updateInterface();
        });

                function parseQuizOption(optionText) {
                        const cleanText = optionText.split("\n")[0].trim();
                        return cleanText.replace(/\*\*/g, "");
        }

                function parseReflectionQuestion(questionText) {
                        return questionText.replace(/^\d+\.\s*/, "").trim();
        }
        function parseCase(caseText) {
            try {
                const caseData = {
                    antecedent: "",
                    belief: "",
                    consequence: "",
                };

                                const patterns = {
                    antecedent: {
                        ru: /(?:–ê–Ω—Ç–µ—Ü–µ–¥–µ–Ω—Ç|Antecedent):\s*"([^"]+)"/,
                        en: /(?:Antecedent):\s*"([^"]+)"/,
                        es: /(?:Antecedente):\s*"([^"]+)"/,
                    },
                    belief: {
                        ru: /(?:–£–±–µ–∂–¥–µ–Ω–∏–µ|Belief):\s*"([^"]+)"/,
                        en: /(?:Belief):\s*"([^"]+)"/,
                        es: /(?:Creencia):\s*"([^"]+)"/,
                    },
                    consequence: {
                        ru: /(?:–°–ª–µ–¥—Å—Ç–≤–∏–µ|Consequence).*?:\s*"([^"]+)"/,
                        en: /(?:Consequence).*?:\s*"([^"]+)"/,
                        es: /(?:Consecuencia).*?:\s*"([^"]+)"/,
                    },
                };

                const antecedentMatch = caseText.match(
                    patterns.antecedent[currentLanguage]
                );
                const beliefMatch = caseText.match(patterns.belief[currentLanguage]);
                const consequenceMatch = caseText.match(
                    patterns.consequence[currentLanguage]
                );

                if (!antecedentMatch || !beliefMatch || !consequenceMatch) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–µ–π—Å–∞");
                }

                caseData.antecedent = antecedentMatch[1].trim();
                caseData.belief = beliefMatch[1].trim();
                caseData.consequence = consequenceMatch[1].trim();

                                for (const [key, value] of Object.entries(caseData)) {
                    if (!value || value.length < 10) {
                        throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ${key}`);
                    }
                }

                return caseData;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∫–µ–π—Å–∞:", error);
                throw new Error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–µ–π—Å–∞: ${error.message}`);
            }
        }
                function parseQuizResponse(response) {
            try {
                                const cleanResponse = response
                    .replace(/```json/g, "")
                    .replace(/```/g, "")
                    .trim();

                                const data = JSON.parse(cleanResponse);

                                if (
                    !data.quiz ||
                    !data.quiz.questions ||
                    !Array.isArray(data.quiz.questions)
                ) {
                    throw new Error("Invalid quiz data structure");
                }

                                return {
                    questions: data.quiz.questions.map((q) => ({
                        question: q.question,
                        options: q.options,
                        correctAnswer: q.correctAnswer,
                        explanation: q.explanation,
                    })),
                    totalQuestions: data.quiz.totalQuestions,
                };
            } catch (error) {
                console.error("Error parsing quiz response:", error);
                throw new Error("Failed to parse quiz data");
            }
        }
        function parseReflectionResponse(response) {
            try {
                                let data;
                try {
                    data = JSON.parse(response);
                } catch {
                                        const cleanResponse = response
                        .replace(/```json\n?/g, "")
                        .replace(/```\n?/g, "")
                        .trim();

                                        const jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        data = JSON.parse(jsonMatch[0]);
                    } else {
                                                const lines = cleanResponse.split("\n").filter((line) => line.trim());
                        data = {
                            questions: lines.map((line, index) => ({
                                question: line.replace(/^\d+\.\s*/, "").trim(),
                                hint: null,
                            })),
                        };
                    }
                }

                                if (!data.questions || !Array.isArray(data.questions)) {
                    throw new Error("Invalid reflection data structure");
                }

                                return {
                    questions: data.questions.map((q) => ({
                        question: typeof q === "string" ? q : q.question,
                        hint: q.hint || null,
                    })),
                };
            } catch (error) {
                console.error("Error parsing reflection response:", error);
                console.error("Original response:", response);
                throw new Error("Failed to parse reflection data");
            }
        }

                function hideLanguageSelector() {
            const langSelector = document.querySelector(".language-selector");
            if (langSelector) {
                langSelector.style.display = "none";
            }
        }

        function showLanguageSelector() {
            const langSelector = document.querySelector(".language-selector");
            if (langSelector) {
                langSelector.style.display = "block";
            }
        }



                function returnToHome() {
            location.reload();         }


                function returnToHome() {
                        document.querySelector(".case-result").classList.add("hidden");
            document.getElementById("quizSection").classList.add("hidden");
            document.getElementById("reflectionSection").classList.add("hidden");

                        document.querySelector(".chat-button").classList.add("hidden");
            document.querySelector(".chat-window").classList.remove("active");

                        document.querySelector(".preview-section").style.display = "block";
            showLanguageSelector();

                        currentCaseData = null;
            currentQuizData = null;
            currentQuizStep = 1;
            userAnswers = [];
            currentReflectionData = null;
            chatHistory = [];
            isChatOpen = false;
        }
                function updateHomeButtons() {
            document.querySelectorAll(".home-btn").forEach((btn) => {
                btn.addEventListener("click", returnToHome);
            });
        }

    </script>
    <button class="chat-button hidden">
        <i class="fas fa-comments"></i>
    </button>

    <div class="chat-window">
        <div class="chat-header">
            <i class="fas fa-robot"></i> CBT Assistant
        </div>
        <div class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" placeholder="Type your message...">
            <button type="button">Send</button>
        </div>
    </div>
</body>

</html>